---
title: "blog-code-6"
author: "Ella Trembanis"
date: "2024-10-13"
output: html_document
---

# Set-Up

``` {r load libraries, echo=FALSE, include=FALSE, warning=FALSE}
library(car)
library(caret)
library(CVXR)
library(foreign)
library(glmnet)
library(haven)
library(janitor)
library(kableExtra)
library(maps)
library(mlr3)
library(randomForest)
library(ranger)
library(RColorBrewer)
library(sf)
library(tidyverse)
library(viridis)
library(cowplot)
library(curl)
library(geofacet)
library(randomForest)
library(rstan)
library(scales)
library(shinystan)
```

```{r custom theme, echo=FALSE, include=FALSE, warning=FALSE}
my_theme <- function() {
  theme(
  # set panel features
  panel.border = element_rect(color = "#000033", fill = NA, linetype = 1),
  panel.background = element_rect(fill = "#FFFFFF"),
  panel.grid.major.x = element_line(color = "#9999CC", linetype = 2, size = 0.2),
  panel.grid.minor.x = element_blank(),
  panel.grid.major.y = element_line(color = "#9999CC", linetype = 2, size = 0.2),
  panel.grid.minor.y = element_blank(),
  # set text and axis features
  text = element_text(color = "#000033", family = "Courier"),
  title = element_text(color = "#000033", face = "bold", family = "Courier"),
  axis.ticks = element_line(color = "#000033"),
  # set legend features
  legend.position = "bottom",
  legend.background = element_rect(color = "#000033", fill = NA, linetype = 1)
  )
}
```

```{r simplified custom theme, echo=FALSE, include=FALSE, warning=FALSE}
my_map_theme <- function() {
  theme(
    # set panel features
    panel.background = element_rect(fill = "#FFFFFF"),
    # set text features
    text = element_text(color = "#000033", family = "Courier"),
    title = element_text(color = "#000033", face = "bold", family = "Courier"),
    # set legend features
    legend.position = "bottom",
    legend.title.position = "top",
    legend.background = element_rect(color = "#000033", fill = NA, linetype = 1),
    # set axis features to not display
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
}
```

```{r read data, echo=FALSE, include=FALSE, warning=FALSE}
# Read popular vote datasets. 
d_popvote <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/popvote_1948_2020.csv")
d_state_popvote <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/state_popvote_1948_2020.csv")

# Read elector distribution dataset. 
d_ec <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/corrected_ec_1948_2024.csv")

# Read ads datasets. 
ad_campaigns <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/ad_campaigns_2000-2012.csv")
ad_creative <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/ad_creative_2000-2012.csv")
ads_2020 <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/ads_2020.csv")
facebook_ads_2020 <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/do not push/data/facebook_ads_2020.csv")
facebook_ads_biden_2020 <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/facebook_ads_biden_2020.csv")
campaign_spending <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/FEC_contributions_by_state_2008_2024.csv")

# Read polling data. 
d_polls <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/national_polls_1968-2024(2).csv")
d_state_polls <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/state_polls_1968-2024(2).csv")

# Process state-level polling data. 
d_pollav_state <- d_state_polls |> 
  group_by(year, state, party) |>
  mutate(mean_pollav = mean(poll_support, na.rm = TRUE)) |>
  top_n(1, poll_date) |> 
  rename(latest_pollav = poll_support) |>
  select(-c(weeks_left, days_left, poll_date, candidate, before_convention)) |>
  pivot_wider(names_from = party, values_from = c(latest_pollav, mean_pollav))

# Read turnout data. 
d_turnout <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week6/data/state_turnout_1980_2022(1).csv")

# Read economic data.
econ <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Blog #3/data/fred_econ.csv") |> 
# filter to most recent available quarter of 2024
  filter(quarter == 2)

# Read consumer sentiment index
ics <- read_csv("/Users/ellatrembanis/Desktop/Gov 1347/election-blog/election-blog/Week4/data/tbqics.csv") |>
  filter(quarter == "Q2") |>
  mutate(
    quarter = if_else(quarter == "Q2", 2, NA)
    )

# Merge econ + ics
econ <- econ |>
  left_join(ics, by = join_by(year, quarter))

# Join data for time for change model.
tfc_train <- d_popvote |> 
  left_join(econ, by = "year") |> 
  filter(incumbent_party) |>
  mutate(incumbent = as.numeric(incumbent)) |>
  filter(year >= 1968)

# map of u.s. with state borders
states_map <- map_data("state")
```

```{r modelling, echo=FALSE, include=FALSE, warning=FALSE}
# use weeks left as columns
week_poll <- d_polls |> 
  group_by(year, party, weeks_left) |>
  summarize(mean_poll_week = mean(poll_support)) |> 
  filter(weeks_left <= 30) |> 
  pivot_wider(names_from = weeks_left, values_from = mean_poll_week) |>
# merge national vote
  left_join(d_popvote, by = c("year", "party"))

# split to train and test
week_poll_train <- week_poll |> 
  filter(year <= 2020)
week_poll_test <- week_poll |> 
  filter(year == 2024)

# rename
colnames(week_poll)[3:33] <- paste0("poll_weeks_left_", 0:30)
colnames(week_poll_train)[3:33] <- paste0("poll_weeks_left_", 0:30)
colnames(week_poll_test)[3:33] <- paste0("poll_weeks_left_", 0:30)

# merge
combined <- econ |> 
  left_join(week_poll, by = "year") |> 
  filter(year %in% c(unique(d_popvote$year), 2024)) |> 
  group_by(party) |> 
  mutate(pv2p_lag1 = lag(pv2p, 1), 
         pv2p_lag2 = lag(pv2p, 2)) |> 
  ungroup()

combined[29, "incumbent_party"] = TRUE
combined[30, "incumbent_party"] = FALSE
combined[29, "incumbent"] = FALSE

combined[1, "pv2p_lag1"] = 0.612033364797
combined[3, "pv2p_lag2"] = 0.612033364797
combined[2, "pv2p_lag1"] = 0.387966635203
combined[4, "pv2p_lag2"] = 0.387966635203
combined[1, "pv2p_lag2"] = 0.500874006373
combined[2, "pv2p_lag2"] = 0.499125993627

combined <- combined |> 
  mutate(gdp_growth_x_incumbent_party = GDP_growth_quarterly * incumbent_party,
         cpi_x_incumbent_party = CPI * incumbent_party)

combined_lags <- combined |>
  select(year, party, pv2p, pv2p_lag1, pv2p_lag2)

# merge datasets (polling + fundamentals + time for change)
combined_tfc <- tfc_train |>
  left_join(combined, by = join_by(year, candidate, GDP_growth_quarterly, party, pv, pv2p, incumbent, incumbent_party)) |>
  mutate(
    gdp_growth_x_prev_admin = GDP_growth_quarterly * prev_admin.x
  )

# add back in values lost in merge
combined_tfc[15, "incumbent"] = 0 # Harris incumbency status
combined_tfc[15, "poll_weeks_left_5"] = 48.52034 # Harris poll at t-minus 5 weeks
combined_tfc[15, "pv2p_lag1"] = 52.2698591 # Biden pv2p in 2020
combined_tfc[15, "gdp_growth_x_incumbent_party"] = 3.0 # gdp growth & party incumbency interaction term
combined_tfc[15, "ics"] = 71.1

# sequester 2024 data
combined_tfc_24 <- combined_tfc |>
  filter(year == 2024)
```

# Presidential Campaigns: Americaâ€™s Multimillion Dollar Myth?

```{r fig 1 code, echo=FALSE, include=FALSE, warning=FALSE}
## When to Buy Ads? 
fig1 <- ad_campaigns |>
  mutate(year = as.numeric(substr(air_date, 1, 4))) |>
  mutate(month = as.numeric(substr(air_date, 6, 7))) |>
  filter(year %in% c(2000, 2004, 2008, 2012), month > 7) |>
  group_by(cycle, air_date, party) |>
  summarise(total_cost = sum(total_cost)) |>
  ggplot(aes(x=air_date, y=total_cost, color=party)) +
  # scale_x_date(date_labels = "%b, %Y") +
  scale_y_continuous(labels = dollar_format()) +
  scale_color_manual(values = c("#7CB9E8", "#E8747C"), name = "") +
  geom_line() + geom_point(size=0.5) +
  facet_wrap(cycle ~ ., scales="free") +
  xlab("") + ylab("ad spend") +
  ggtitle("Fig I. Campaign Spending by Party, 2000-2012") +
  my_theme() +
  theme(axis.title = element_text(size=20),
        axis.text = element_text(size=11),
        strip.text.x = element_text(size = 20))
```

```{r fig 1 print, echo=FALSE, include=TRUE, warning=FALSE}
fig1
```

```{r fig 2 code, echo=FALSE, include=FALSE, warning=FALSE}
# Spending by State, 2024
fig2 <- state_spend <- campaign_spending |>
  filter(election_year == 2024) |>
  group_by(party, contribution_state) |>
  summarise(total_cont = sum(contribution_receipt_amount)) |>
  # ggplot(aes(x=air_date, y=log(total_cost+1), color=party)) +
  ggplot(aes(x=party, y=total_cont, fill=party)) +
  geom_bar(stat="identity") +
  facet_geo(~ contribution_state, scales="free_x") +
  scale_fill_manual(values = c("#7CB9E8", "#E8747C")) +
  scale_y_continuous(labels = unit_format(unit = "M", scale = 1e-6)) +
  xlab("") + ylab("Campaign Spending") +
  ggtitle("Fig II. Campaign Spending by State, 2024") +
  my_theme() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

```{r fig 2 print, echo=FALSE, include=TRUE, warning=FALSE}
fig2
```

```{r fig 3 code, echo=FALSE, include=TRUE, warning=FALSE}
fig3 <- campaign_spending |>
  filter(election_year == 2024 & party == "Democrat") |>
  group_by(contribution_state) |>
  summarise(dem_cont = sum(contribution_receipt_amount)/1000000) |>
  slice_max(dem_cont, n = 10) |>
  ggplot() +
  geom_col(mapping = aes(y = fct_reorder(contribution_state, dem_cont), x = dem_cont), fill = "#7CB9E8") +
  xlab("Democratic Spending (in Millions of $)") +
  ylab("State") +
  ggtitle("Fig III. Democratic Campaign Spending by State") +
  my_theme()
```

```{r fig 3 print, echo=FALSE, include=TRUE, warning=FALSE}
fig3
```

```{r fig 4 code, echo=FALSE, include=FALSE, warning=FALSE}
fig4 <- campaign_spending |>
  filter(election_year == 2024 & party == "Republican") |>
  group_by(contribution_state) |>
  summarise(dem_cont = sum(contribution_receipt_amount)/1000000) |>
  slice_max(dem_cont, n = 10) |>
  ggplot() +
  geom_col(mapping = aes(y = fct_reorder(contribution_state, dem_cont), x = dem_cont), fill = "#E8747C") +
  xlab("Republican Spending (in Millions of $)") +
  ylab("State") +
  ggtitle("Fig IV. Republican Campaign Spending by State") +
  my_theme()
```

```{r fig 4 print, echo=FALSE, include=TRUE, warning=FALSE}
fig4
```


# This Week's Prediction

```{r states take 2, echo=FALSE, include=FALSE, warning=FALSE}
# popvote
d_popvote_simplified <- d_popvote |>
  select(year, party, candidate, incumbent, pv2p, prev_admin, incumbent_party) |>
  mutate(
    party = if_else(party == "republican", "REP", "DEM")
  )

# ics and gdp
d_econ_vars <- econ |>
  select(year, ics, GDP_growth_quarterly)

# nat poll
d_natpoll <- week_poll |>
  group_by(year, party) |>
  summarize(
    poll_week_4 = mean(poll_weeks_left_4)
  ) |>
  filter(year >= 1972)
 
# merging

d_popvote_simplified <- d_popvote_simplified |>
  left_join(d_econ_vars, by = "year") |>
  filter(year >= 1972) |>
  select(year, party, candidate, prev_admin, ics, pv2p, incumbent, incumbent_party, GDP_growth_quarterly)

d_popvote_simplified <- d_popvote_simplified |>
  left_join(d_natpoll) |>
  filter(year >= 1972) |>
  select(year, party, candidate, prev_admin, ics, pv2p, incumbent, incumbent_party, GDP_growth_quarterly, poll_week_4)
  
d_state_popvote_simplified <- d_state_popvote |>
  pivot_longer(
    cols = c(D_pv2p, R_pv2p),
    names_to = "party",
    values_to = "state_pv2p"
  ) |>
  mutate(
    party = if_else(party == "D_pv2p", "DEM", "REP")
  ) |>
  select(year, state, party, state_pv2p)

d_state_popvote_2024 <- data.frame(year = rep(2024, 102),
                                   state = rep(c(unique(d_state_popvote_simplified$state)), 2),
                                   party = rep(c(unique(d_state_popvote_simplified$party)), 51),
                                   state_pv2p = rep(NA, 102))

d_state_popvote_simplified <- rbind(d_state_popvote_simplified, d_state_popvote_2024)

# average state polls
d_state_polls_simplified <- d_state_polls |>
  group_by(state, year, party) |>
  summarize(
    mean_support = mean(poll_support, na.rm=T)
  )

#more  merging

d_state_tfmc <- d_state_popvote_simplified |>
  left_join(d_state_polls_simplified)

d_state_tfmc <- d_state_tfmc |>
  left_join(d_popvote_simplified, join_by(year, party)) |>
  filter(party == "DEM" & year >= "1972")

# create lag & poll error variables
d_state_tfmc <- d_state_tfmc |>
  mutate(
    state_poll_error = mean_support - state_pv2p
  )

# create tfmc dataframe for every state
for (variable in unique(d_state_tfmc$state)) {
  assign(variable, d_state_tfmc %>% filter (state == variable), envir = .GlobalEnv)
}

# separate 2024 and predict by state (where 2024 polls are available!)
Arizona <- Arizona |> mutate(state_pv2p_lag = lag(state_pv2p, n=1)) # populate lag variable
Arizona24 <- Arizona |> filter(year == 2024) # testing data
tfmc_az <- lm(state_pv2p ~ ics + mean_support + prev_admin + state_pv2p_lag + poll_week_4, data = Arizona) # regression
summary(tfmc_az) # produce summary
az_pred <- predict(tfmc_az, Arizona24, interval = "none") # point estimate of dem's popular vote share

California <- California |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
California$state_pv2p_lag[California$year == 2024] <- California$state_pv2p[California$year == 2020]
California24 <- California |> filter(year == 2024)
tfmc_ca <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = California)
summary(tfmc_ca)
ca_pred <- predict(tfmc_ca, California24, interval = "none")

Florida <- Florida |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Florida$state_pv2p_lag[Florida$year == 2024] <- Florida$state_pv2p[Florida$year == 2020]
Florida24 <- Florida |> filter(year == 2024)
tfmc_fl <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Florida)
summary(tfmc_fl)
fl_pred <- predict(tfmc_fl, Florida24, interval = "none")

Georgia <- Georgia |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Georgia$state_pv2p_lag[Georgia$year == 2024] <- Georgia$state_pv2p[Georgia$year == 2020]
Georgia24 <- Georgia |> filter(year == 2024)
tfmc_ga <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Georgia)
summary(tfmc_ga)
ga_pred <- predict(tfmc_ga, Georgia24, interval = "none")

Maryland <- Maryland |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Maryland$state_pv2p_lag[Maryland$year == 2024] <- Maryland$state_pv2p[Maryland$year == 2020]
Maryland24 <- Maryland |> filter(year == 2024)
tfmc_md <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Maryland)
summary(tfmc_md)
md_pred <- predict(tfmc_md, Maryland24, interval = "none")

Michigan <- Michigan |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Michigan$state_pv2p_lag[Michigan$year == 2024] <- Michigan$state_pv2p[Michigan$year == 2020]
Michigan24 <- Michigan |> filter(year == 2024)
tfmc_mi <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Michigan)
summary(tfmc_mi)
mi_pred <- predict(tfmc_mi, Michigan24, interval = "none")

Minnesota <- Minnesota |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Minnesota$state_pv2p_lag[Minnesota$year == 2024] <- Minnesota$state_pv2p[Minnesota$year == 2020]
Minnesota24 <- Minnesota |> filter(year == 2024)
tfmc_mn <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Minnesota)
summary(tfmc_mn)
mn_pred <- predict(tfmc_mn, Minnesota24, interval = "none")

Missouri <- Missouri |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Missouri$state_pv2p_lag[Missouri$year == 2024] <- Missouri$state_pv2p[Missouri$year == 2020]
Missouri24 <- Missouri |> filter(year == 2024)
tfmc_mo <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Missouri)
summary(tfmc_mo)
mo_pred <- predict(tfmc_mo, Missouri24, interval = "none")

Montana <- Montana |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Montana$state_pv2p_lag[Montana$year == 2024] <- Montana$state_pv2p[Montana$year == 2020]
Montana24 <- Montana |> filter(year == 2024)
tfmc_mt <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Montana)
summary(tfmc_mt)
mt_pred <- predict(tfmc_mt, Montana24, interval = "none")

Nevada <- Nevada |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Nevada$state_pv2p_lag[Nevada$year == 2024] <- Nevada$state_pv2p[Nevada$year == 2020]
Nevada24 <- Nevada |> filter(year == 2024)
tfmc_nv <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Nevada)
summary(tfmc_nv)
nv_pred <- predict(tfmc_nv, Nevada24, interval = "none")

`New Hampshire` <- `New Hampshire` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
`New Hampshire`$state_pv2p_lag[`New Hampshire`$year == 2024] <- `New Hampshire`$state_pv2p[`New Hampshire`$year == 2020]
NH24 <- `New Hampshire` |> filter(year == 2024)
tfmc_nh <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `New Hampshire`)
summary(tfmc_nh)
nh_pred <- predict(tfmc_nh, NH24, interval = "none")

`New Mexico` <- `New Mexico` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
`New Mexico`$state_pv2p_lag[`New Mexico`$year == 2024] <- `New Mexico`$state_pv2p[`New Mexico`$year == 2020]
NM24 <- `New Mexico` |> filter(year == 2024)
tfmc_nm <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `New Mexico`)
summary(tfmc_nm)
nm_pred <- predict(tfmc_nm, NM24, interval = "none")

`New York` <- `New York` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
`New York`$state_pv2p_lag[`New York`$year == 2024] <- `New York`$state_pv2p[`New York`$year == 2020]
NY24 <- `New York` |> filter(year == 2024)
tfmc_ny <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `New York`)
summary(tfmc_ny)
ny_pred <- predict(tfmc_ny, NY24, interval = "none")

`North Carolina` <- `North Carolina` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
`North Carolina`$state_pv2p_lag[`North Carolina`$year == 2024] <- `North Carolina`$state_pv2p[`North Carolina`$year == 2020]
NC24 <- `North Carolina` |> filter(year == 2024)
tfmc_nc <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `North Carolina`)
summary(tfmc_nc)
nc_pred <- predict(tfmc_nc, NC24, interval = "none")

Ohio <- Ohio |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Ohio$state_pv2p_lag[Ohio$year == 2024] <- Ohio$state_pv2p[Ohio$year == 2020]
Ohio24 <- Ohio |> filter(year == 2024)
tfmc_oh <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Ohio)
summary(tfmc_oh)
oh_pred <- predict(tfmc_oh, Ohio24, interval = "none")

Pennsylvania <- Pennsylvania |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Pennsylvania$state_pv2p_lag[Pennsylvania$year == 2024] <- Pennsylvania$state_pv2p[Pennsylvania$year == 2020]
Pennsylvania24 <- Pennsylvania |> filter(year == 2024)
tfmc_pa <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Pennsylvania)
summary(tfmc_pa)
pa_pred <- predict(tfmc_pa, Pennsylvania24, interval = "none")

Texas <- Texas |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Texas$state_pv2p_lag[Texas$year == 2024] <- Texas$state_pv2p[Texas$year == 2020]
Texas24 <- Texas |> filter(year == 2024)
tfmc_tx <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Texas)
summary(tfmc_tx)
tx_pred <- predict(tfmc_tx, Texas24, interval = "none")

Virginia <- Virginia |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Virginia$state_pv2p_lag[Virginia$year == 2024] <- Virginia$state_pv2p[Virginia$year == 2020]
Virginia24 <- Virginia |> filter(year == 2024)
tfmc_va <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Virginia)
summary(tfmc_va)
va_pred <- predict(tfmc_va, Virginia24, interval = "none")

Wisconsin <- Wisconsin |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Wisconsin$state_pv2p_lag[Wisconsin$year == 2024] <- Wisconsin$state_pv2p[Wisconsin$year == 2020]
Wisconsin24 <- Wisconsin |> filter(year == 2024)
tfmc_wi <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Wisconsin)
summary(tfmc_wi)
wi_pred <- predict(tfmc_wi, Wisconsin24, interval = "none")

# separate 2024 and predict by state (where 2024 polls are not available!)
Alabama <- Alabama |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Alabama24 <- data.frame(year = 2024,
                        state = "Alabama",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Alabama$state_pv2p[Alabama$year == 2020],
                        poll_error = Alabama$state_poll_error[Alabama$year == 2020],
                        mean_support = Alabama$state_pv2p[Alabama$year == 2020] + Alabama$state_poll_error[Alabama$year == 2020])
tfmc_al <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Alabama)
summary(tfmc_al)
al_pred <- predict(tfmc_al, Alabama24, interval = "none")

Alaska <- Alaska |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Alaska24 <- data.frame(year = 2024,
                        state = "Alaska",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Alaska$state_pv2p[Alaska$year == 2020],
                        poll_error = Alaska$state_poll_error[Alaska$year == 2020],
                        mean_support = Alaska$state_pv2p[Alaska$year == 2020] + Alaska$state_poll_error[Alaska$year == 2020])
tfmc_ak <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Alaska)
summary(tfmc_ak)
ak_pred <- predict(tfmc_ak, Alaska24, interval = "none")

Arkansas <- Arkansas |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Arkansas24 <- data.frame(year = 2024,
                        state = "Arkansas",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Arkansas$state_pv2p[Arkansas$year == 2020],
                        poll_error = Arkansas$state_poll_error[Arkansas$year == 2020],
                        mean_support = Arkansas$state_pv2p[Arkansas$year == 2020] + Arkansas$state_poll_error[Arkansas$year == 2020])
tfmc_ar <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Arkansas)
summary(tfmc_ar)
ar_pred <- predict(tfmc_ar, Arkansas24, interval = "none")

Colorado <- Colorado |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Colorado24 <- data.frame(year = 2024,
                        state = "Colorado",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Colorado$state_pv2p[Colorado$year == 2020],
                        poll_error = Colorado$state_poll_error[Colorado$year == 2020],
                        mean_support = Colorado$state_pv2p[Colorado$year == 2020] + Colorado$state_poll_error[Colorado$year == 2020])
tfmc_co <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Colorado)
summary(tfmc_co)
co_pred <- predict(tfmc_co, Colorado24, interval = "none")

Connecticut <- Connecticut |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Connecticut24 <- data.frame(year = 2024,
                        state = "Connecticut",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Connecticut$state_pv2p[Connecticut$year == 2020],
                        poll_error = Connecticut$state_poll_error[Connecticut$year == 2020],
                        mean_support = Connecticut$state_pv2p[Connecticut$year == 2020] + Connecticut$state_poll_error[Connecticut$year == 2020])
tfmc_ct <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Connecticut)
summary(tfmc_ct)
ct_pred <- predict(tfmc_ct, Connecticut24, interval = "none")

Delaware <- Delaware |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Delaware24 <- data.frame(year = 2024,
                        state = "Delaware",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Delaware$state_pv2p[Delaware$year == 2020],
                        poll_error = Delaware$state_poll_error[Delaware$year == 2020],
                        mean_support = Delaware$state_pv2p[Delaware$year == 2020] + Delaware$state_poll_error[Delaware$year == 2020])
tfmc_de <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Delaware)
summary(tfmc_de)
de_pred <- predict(tfmc_de, Delaware24, interval = "none")

Hawaii <- Hawaii |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Hawaii24 <- data.frame(year = 2024,
                        state = "Hawaii",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Hawaii$state_pv2p[Hawaii$year == 2020],
                        poll_error = Hawaii$state_poll_error[Hawaii$year == 2020],
                        mean_support = Hawaii$state_pv2p[Hawaii$year == 2020] + Hawaii$state_poll_error[Hawaii$year == 2020])
tfmc_hi <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Hawaii)
summary(tfmc_hi)
hi_pred <- predict(tfmc_hi, Hawaii24, interval = "none")

Idaho <- Idaho |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Idaho24 <- data.frame(year = 2024,
                        state = "Idaho",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Idaho$state_pv2p[Idaho$year == 2020],
                        poll_error = Idaho$state_poll_error[Idaho$year == 2020],
                        mean_support = Idaho$state_pv2p[Idaho$year == 2020] + Idaho$state_poll_error[Idaho$year == 2020])
tfmc_id <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Idaho)
summary(tfmc_id)
id_pred <- predict(tfmc_id, Idaho24, interval = "none")

Illinois <- Illinois |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Illinois24 <- data.frame(year = 2024,
                        state = "Illinois",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Illinois$state_pv2p[Illinois$year == 2020],
                        poll_error = Illinois$state_poll_error[Illinois$year == 2020],
                        mean_support = Illinois$state_pv2p[Illinois$year == 2020] + Illinois$state_poll_error[Illinois$year == 2020])
tfmc_il <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Illinois)
summary(tfmc_il)
il_pred <- predict(tfmc_il, Illinois24, interval = "none")

Indiana <- Indiana |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Indiana24 <- data.frame(year = 2024,
                        state = "Indiana",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Indiana$state_pv2p[Indiana$year == 2020],
                        poll_error = Indiana$state_poll_error[Indiana$year == 2020],
                        mean_support = Indiana$state_pv2p[Indiana$year == 2020] + Indiana$state_poll_error[Indiana$year == 2020])
tfmc_in <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Indiana)
summary(tfmc_in)
in_pred <- predict(tfmc_in, Indiana24, interval = "none")

Iowa <- Iowa |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Iowa24 <- data.frame(year = 2024,
                     state = "Iowa",
                     party = "DEM",
                     state_pv2p = NA,
                     ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                     incumbent = TRUE,
                     poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                     state_pv2p_lag = Iowa$state_pv2p[Iowa$year == 2020],
                     poll_error = Iowa$state_poll_error[Iowa$year == 2020],
                     mean_support = Iowa$state_pv2p[Iowa$year == 2020] + Iowa$state_poll_error[Iowa$year == 2020])
tfmc_ia <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Iowa)
summary(tfmc_ia)
ia_pred <- predict(tfmc_ia, Iowa24, interval = "none")

Kansas <- Kansas |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Kansas24 <- data.frame(year = 2024,
                       state = "Kansas",
                       party = "DEM",
                       state_pv2p = NA,
                       ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                       incumbent = TRUE,
                       poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                       state_pv2p_lag = Kansas$state_pv2p[Kansas$year == 2020],
                       poll_error = Kansas$state_poll_error[Kansas$year == 2020],
                       mean_support = Kansas$state_pv2p[Kansas$year == 2020] + Kansas$state_poll_error[Kansas$year == 2020])
tfmc_ks <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Kansas)
summary(tfmc_ks)
ks_pred <- predict(tfmc_ks, Kansas24, interval = "none")

Kentucky <- Kentucky |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Kentucky24 <- data.frame(year = 2024,
                         state = "Kentucky",
                         party = "DEM",
                         state_pv2p = NA,
                         ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                         incumbent = TRUE,
                         poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                         state_pv2p_lag = Kentucky$state_pv2p[Kentucky$year == 2020],
                         poll_error = Kentucky$state_poll_error[Kentucky$year == 2020],
                         mean_support = Kentucky$state_pv2p[Kentucky$year == 2020] + Kentucky$state_poll_error[Kentucky$year == 2020])
tfmc_ky <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Kentucky)
summary(tfmc_ky)
ky_pred <- predict(tfmc_ky, Kentucky24, interval = "none")

Louisiana <- Louisiana |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Louisiana24 <- data.frame(year = 2024,
                          state = "Louisiana",
                          party = "DEM",
                          state_pv2p = NA,
                          ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                          incumbent = TRUE,
                          poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                          state_pv2p_lag = Louisiana$state_pv2p[Louisiana$year == 2020],
                          poll_error = Louisiana$state_poll_error[Louisiana$year == 2020],
                          mean_support = Louisiana$state_pv2p[Louisiana$year == 2020] + Louisiana$state_poll_error[Louisiana$year == 2020])
tfmc_la <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Louisiana)
summary(tfmc_la)
la_pred <- predict(tfmc_la, Louisiana24, interval = "none")

Maine <- Maine |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Maine24 <- data.frame(year = 2024,
                      state = "Maine",
                      party = "DEM",
                      state_pv2p = NA,
                      ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                      incumbent = TRUE,
                      poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                      state_pv2p_lag = Maine$state_pv2p[Maine$year == 2020],
                      poll_error = Maine$state_poll_error[Maine$year == 2020],
                      mean_support = Maine$state_pv2p[Maine$year == 2020] + Maine$state_poll_error[Maine$year == 2020])
tfmc_me <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Maine)
summary(tfmc_me)
me_pred <- predict(tfmc_me, Maine24, interval = "none")

Massachusetts <- Massachusetts |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Massachusetts24 <- data.frame(year = 2024,
                               state = "Massachusetts",
                               party = "DEM",
                               state_pv2p = NA,
                               ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                               incumbent = TRUE,
                               poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                               state_pv2p_lag = Massachusetts$state_pv2p[Massachusetts$year == 2020],
                               poll_error = Massachusetts$state_poll_error[Massachusetts$year == 2020],
                               mean_support = Massachusetts$state_pv2p[Massachusetts$year == 2020] + Massachusetts$state_poll_error[Massachusetts$year == 2020])
tfmc_ma <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Massachusetts)
summary(tfmc_ma)
ma_pred <- predict(tfmc_ma, Massachusetts24, interval = "none")

Mississippi <- Mississippi |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Mississippi24 <- data.frame(year = 2024,
                            state = "Mississippi",
                            party = "DEM",
                            state_pv2p = NA,
                            ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                            incumbent = TRUE,
                            poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                            state_pv2p_lag = Mississippi$state_pv2p[Mississippi$year == 2020],
                            poll_error = Mississippi$state_poll_error[Mississippi$year == 2020],
                            mean_support = Mississippi$state_pv2p[Mississippi$year == 2020] + Mississippi$state_poll_error[Mississippi$year == 2020])
tfmc_ms <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Mississippi)
summary(tfmc_ms)
ms_pred <- predict(tfmc_ms, Mississippi24, interval = "none")

Nebraska <- Nebraska |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Nebraska24 <- data.frame(year = 2024,
                         state = "Nebraska",
                         party = "DEM",
                         state_pv2p = NA,
                         ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                         incumbent = TRUE,
                         poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                         state_pv2p_lag = Nebraska$state_pv2p[Nebraska$year == 2020],
                         poll_error = Nebraska$state_poll_error[Nebraska$year == 2020],
                         mean_support = Nebraska$state_pv2p[Nebraska$year == 2020] + Nebraska$state_poll_error[Nebraska$year == 2020])
tfmc_ne <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Nebraska)
summary(tfmc_ne)
ne_pred <- predict(tfmc_ne, Nebraska24, interval = "none")

`New Jersey` <- `New Jersey` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
NJ24 <- data.frame(year = 2024,
                           state = "New Jersey",
                           party = "DEM",
                           state_pv2p = NA,
                           ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                           incumbent = TRUE,
                           poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                           state_pv2p_lag = `New Jersey`$state_pv2p[`New Jersey`$year == 2020],
                           poll_error = `New Jersey`$state_poll_error[`New Jersey`$year == 2020],
                           mean_support = `New Jersey`$state_pv2p[`New Jersey`$year == 2020] + `New Jersey`$state_poll_error[`New Jersey`$year == 2020])
tfmc_nj <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `New Jersey`)
summary(tfmc_nj)
nj_pred <- predict(tfmc_nj, NJ24, interval = "none")

`North Dakota` <- `North Dakota` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
ND24 <- data.frame(year = 2024,
                             state = "North Dakota",
                             party = "DEM",
                             state_pv2p = NA,
                             ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                             incumbent = TRUE,
                             poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                             state_pv2p_lag = `North Dakota`$state_pv2p[`North Dakota`$year == 2020],
                             poll_error = `North Dakota`$state_poll_error[`North Dakota`$year == 2020],
                             mean_support = `North Dakota`$state_pv2p[`North Dakota`$year == 2020] + `North Dakota`$state_poll_error[`North Dakota`$year == 2020])
tfmc_nd <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `North Dakota`)
summary(tfmc_nd)
nd_pred <- predict(tfmc_nd, ND24, interval = "none")

Oklahoma <- Oklahoma |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Oklahoma24 <- data.frame(year = 2024,
                         state = "Oklahoma",
                         party = "DEM",
                         state_pv2p = NA,
                         ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                         incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                         state_pv2p_lag = Oklahoma$state_pv2p[Oklahoma$year == 2020],
                         poll_error = Oklahoma$state_poll_error[Oklahoma$year == 2020],
                         mean_support = Oklahoma$state_pv2p[Oklahoma$year == 2020] + Oklahoma$state_poll_error[Oklahoma$year == 2020])
tfmc_ok <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Oklahoma)
summary(tfmc_ok)
ok_pred <- predict(tfmc_ok, Oklahoma24, interval = "none")

Oregon <- Oregon |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Oregon24 <- data.frame(year = 2024,
                       state = "Oregon",
                       party = "DEM",
                       state_pv2p = NA,
                       ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                       incumbent = TRUE,
                       poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                       state_pv2p_lag = Oregon$state_pv2p[Oregon$year == 2020],
                       poll_error = Oregon$state_poll_error[Oregon$year == 2020],
                       mean_support = Oregon$state_pv2p[Oregon$year == 2020] + Oregon$state_poll_error[Oregon$year == 2020])
tfmc_or <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Oregon)
summary(tfmc_or)
or_pred <- predict(tfmc_or, Oregon24, interval = "none")

`Rhode Island` <- `Rhode Island` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
RI24 <- data.frame(year = 2024,
                             state = "Rhode Island",
                             party = "DEM",
                             state_pv2p = NA,
                             ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                             incumbent = TRUE,
                             poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                             state_pv2p_lag = `Rhode Island`$state_pv2p[`Rhode Island`$year == 2020],
                             poll_error = `Rhode Island`$state_poll_error[`Rhode Island`$year == 2020],
                             mean_support = `Rhode Island`$state_pv2p[`Rhode Island`$year == 2020] + `Rhode Island`$state_poll_error[`Rhode Island`$year == 2020])
tfmc_ri <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `Rhode Island`)
summary(tfmc_ri)
ri_pred <- predict(tfmc_ri, RI24, interval = "none")

`South Carolina` <- `South Carolina` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
SC24 <- data.frame(year = 2024,
                               state = "South Carolina",
                               party = "DEM",
                               state_pv2p = NA,
                               ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                               incumbent = TRUE,
                               poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                               state_pv2p_lag = `South Carolina`$state_pv2p[`South Carolina`$year == 2020],
                               poll_error = `South Carolina`$state_poll_error[`South Carolina`$year == 2020],
                               mean_support = `South Carolina`$state_pv2p[`South Carolina`$year == 2020] + `South Carolina`$state_poll_error[`South Carolina`$year == 2020])
tfmc_sc <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `South Carolina`)
summary(tfmc_sc)
sc_pred <- predict(tfmc_sc, SC24, interval = "none")

`South Dakota` <- `South Dakota` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
SD24 <- data.frame(year = 2024,
                             state = "South Dakota",
                             party = "DEM",
                             state_pv2p = NA,
                             ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                             incumbent = TRUE,
                             poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                             state_pv2p_lag = `South Dakota`$state_pv2p[`South Dakota`$year == 2020],
                             poll_error = `South Dakota`$state_poll_error[`South Dakota`$year == 2020],
                             mean_support = `South Dakota`$state_pv2p[`South Dakota`$year == 2020] + `South Dakota`$state_poll_error[`South Dakota`$year == 2020])
tfmc_sd <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `South Dakota`)
summary(tfmc_sd)
sd_pred <- predict(tfmc_sd, SD24, interval = "none")

Tennessee <- Tennessee |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Tennessee24 <- data.frame(year = 2024,
                          state = "Tennessee",
                          party = "DEM",
                          state_pv2p = NA,
                          ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                          incumbent = TRUE,
                          poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                          state_pv2p_lag = Tennessee$state_pv2p[Tennessee$year == 2020],
                          poll_error = Tennessee$state_poll_error[Tennessee$year == 2020],
                          mean_support = Tennessee$state_pv2p[Tennessee$year == 2020] + Tennessee$state_poll_error[Tennessee$year == 2020])
tfmc_tn <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Tennessee)
summary(tfmc_tn)
tn_pred <- predict(tfmc_tn, Tennessee24, interval = "none")

Utah <- Utah |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Utah24 <- data.frame(year = 2024,
                     state = "Utah",
                     party = "DEM",
                     state_pv2p = NA,
                     ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                     incumbent = TRUE,
                     poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                     state_pv2p_lag = Utah$state_pv2p[Utah$year == 2020],
                     poll_error = Utah$state_poll_error[Utah$year == 2020],
                     mean_support = Utah$state_pv2p[Utah$year == 2020] + Utah$state_poll_error[Utah$year == 2020])
tfmc_ut <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Utah)
summary(tfmc_ut)
ut_pred <- predict(tfmc_ut, Utah24, interval = "none")

Vermont <- Vermont |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Vermont24 <- data.frame(year = 2024,
                        state = "Vermont",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Vermont$state_pv2p[Vermont$year == 2020],
                        poll_error = Vermont$state_poll_error[Vermont$year == 2020],
                        mean_support = Vermont$state_pv2p[Vermont$year == 2020] + Vermont$state_poll_error[Vermont$year == 2020])
tfmc_vt <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Vermont)
summary(tfmc_vt)
vt_pred <- predict(tfmc_vt, Vermont24, interval = "none")

Washington <- Washington |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Washington24 <- data.frame(year = 2024,
                           state = "Washington",
                           party = "DEM",
                           state_pv2p = NA,
                           ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                           incumbent = TRUE,
                           poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                           state_pv2p_lag = Washington$state_pv2p[Washington$year == 2020],
                           poll_error = Washington$state_poll_error[Washington$year == 2020],
                           mean_support = Washington$state_pv2p[Washington$year == 2020] + Washington$state_poll_error[Washington$year == 2020])
tfmc_wa <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Washington)
summary(tfmc_wa)
wa_pred <- predict(tfmc_wa, Washington24, interval = "none")

`West Virginia` <- `West Virginia` |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
WV24 <- data.frame(year = 2024,
                              state = "West Virginia",
                              party = "DEM",
                              state_pv2p = NA,
                              ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                              incumbent = TRUE,
                              poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                              state_pv2p_lag = `West Virginia`$state_pv2p[`West Virginia`$year == 2020],
                              poll_error = `West Virginia`$state_poll_error[`West Virginia`$year == 2020],
                              mean_support = `West Virginia`$state_pv2p[`West Virginia`$year == 2020] + `West Virginia`$state_poll_error[`West Virginia`$year == 2020])
tfmc_wv <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = `West Virginia`)
summary(tfmc_wv)
wv_pred <- predict(tfmc_wv, WV24, interval = "none")

Wyoming <- Wyoming |> mutate(state_pv2p_lag = lag(state_pv2p, n=1))
Wyoming24 <- data.frame(year = 2024,
                        state = "Wyoming",
                        party = "DEM",
                        state_pv2p = NA,
                        ics = unique(d_state_tfmc$ics[d_state_tfmc$year == 2024]),
                        incumbent = TRUE,
                        poll_week_4 = unique(d_state_tfmc$poll_week_4[d_state_tfmc$year == 2024]),
                        state_pv2p_lag = Wyoming$state_pv2p[Wyoming$year == 2020],
                        poll_error = Wyoming$state_poll_error[Wyoming$year == 2020],
                        mean_support = Wyoming$state_pv2p[Wyoming$year == 2020] + Wyoming$state_poll_error[Wyoming$year == 2020])
tfmc_wy <- lm(state_pv2p ~ ics + mean_support + incumbent + state_pv2p_lag + poll_week_4, data = Wyoming)
summary(tfmc_wy)
wy_pred <- predict(tfmc_wy, Wyoming24, interval = "none")

# electoral college prediction
state_ec_pred <- data.frame(stateab = state.abb,
                              pred = c(al_pred, ak_pred, az_pred, ar_pred, ca_pred, co_pred, ct_pred, de_pred, fl_pred, ga_pred, hi_pred, id_pred, il_pred, in_pred, ia_pred, ks_pred, ky_pred, la_pred, me_pred, md_pred, ma_pred, mi_pred, mn_pred, ms_pred, mo_pred, mt_pred, ne_pred, nv_pred, nh_pred, nj_pred, nm_pred, ny_pred, nc_pred, nd_pred, oh_pred, ok_pred, or_pred, pa_pred, ri_pred, sc_pred, sd_pred, tn_pred, tx_pred, ut_pred, vt_pred, va_pred, wv_pred, wa_pred, wi_pred, wy_pred))

d_ec24 <- d_ec |>
  filter(year == 2024)

ec_pred <- state_ec_pred |>
  left_join(d_ec24, by = join_by(stateab))

ec_pred <- ec_pred |>
  mutate(
    winner = if_else(pred > 50, 1, 0), # 1 means the state's ec votes go to Harris
    harris_ec = winner*electors
  )

sum(ec_pred$harris_ec) # 322 EC

# map of continental u.s.
states_map_cont <- states_map |>
  filter(region != "district of columbia")

state_tfmc_pred <- data.frame(region = unique(states_map_cont$region),
                              pred = c(al_pred, az_pred, ar_pred, ca_pred, co_pred, ct_pred, de_pred, fl_pred, ga_pred, id_pred, il_pred, in_pred, ia_pred, ks_pred, ky_pred, la_pred, me_pred, md_pred, ma_pred, mi_pred, mn_pred, ms_pred, mo_pred, mt_pred, ne_pred, nv_pred, nh_pred, nj_pred, nm_pred, ny_pred, nc_pred, nd_pred, oh_pred, ok_pred, or_pred, pa_pred, ri_pred, sc_pred, sd_pred, tn_pred, tx_pred, ut_pred, vt_pred, va_pred, wa_pred, wv_pred, wi_pred, wy_pred))

states_map_pred <- states_map |>
  left_join(state_tfmc_pred, by = "region")

fig5 <- states_map_pred |>
  mutate(
    winner = ifelse(pred > 50, "Democrat", "Republican")
  ) |>
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = winner), color = "#000033") +
  scale_fill_manual(values = c("#3377FF", "#FF6680")) +
  ggtitle("Fig V. Electoral College Prediction, 2024") +
  my_map_theme() +
  theme(strip.text = element_text(size = 12), 
        aspect.ratio = 0.75)
```

```{r fig 5 print, echo=FALSE, include=TRUE, warning=FALSE}
fig5
```

```{r pop vote, echo=FALSE, include=FALSE, warning=FALSE}
# Popular Vote Prediction
d_pop_tfmc <- d_state_tfmc |>
  filter(state == "Delaware") |> # filter to arbitrary state
  select(year, party, candidate, pv2p, ics, incumbent, prev_admin, incumbent_party, GDP_growth_quarterly, poll_week_4) |> # choose only national vars
  mutate(pv2p_lag = lag(pv2p, n = 1))
pop24 <- d_pop_tfmc |> filter(year == 2024) # testing data
tfmc_pop <- lm(pv2p ~ ics + poll_week_4 + incumbent + pv2p_lag, data = d_pop_tfmc)
summary(tfmc_pop)
pop_pred <- predict(tfmc_pop, pop24, interval = "none") # 53.44% Harris 2-party popular vote
```
